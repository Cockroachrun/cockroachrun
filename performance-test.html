<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Test - Cockroach Run</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #00ff00;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid #00ff00;
            margin: 20px 0;
            padding: 20px;
            border-radius: 5px;
        }
        .test-button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 10px;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
        }
        .test-button:hover {
            background: #00cc00;
        }
        .results {
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
            font-family: monospace;
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .metric-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #00ff00;
        }
        .good { color: #00ff00; }
        .warning { color: #ffaa00; }
        .bad { color: #ff0000; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚀 Cockroach Run Performance Test Suite</h1>
        <p>This tool tests the performance improvements made to reduce button lag and improve game responsiveness.</p>

        <div class="test-section">
            <h2>📊 Real-time Performance Metrics</h2>
            <div class="metrics" id="metricsContainer">
                <div class="metric-card">
                    <h3>Frame Rate (FPS)</h3>
                    <div id="fps" class="results">Calculating...</div>
                </div>
                <div class="metric-card">
                    <h3>Button Response Time</h3>
                    <div id="buttonResponse" class="results">Ready to test</div>
                </div>
                <div class="metric-card">
                    <h3>Memory Usage</h3>
                    <div id="memoryUsage" class="results">Monitoring...</div>
                </div>
                <div class="metric-card">
                    <h3>DOM Performance</h3>
                    <div id="domPerformance" class="results">Monitoring...</div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h2>🎯 Button Responsiveness Test</h2>
            <p>Click these buttons rapidly to test response time and lag:</p>
            <button class="test-button" id="testButton1">Test Button 1</button>
            <button class="test-button" id="testButton2">Test Button 2</button>
            <button class="test-button" id="testButton3">Test Button 3</button>
            <button class="test-button" id="testButton4">Test Button 4</button>
            <div class="results" id="buttonTestResults">
                Click buttons above to test responsiveness. Results will appear here.
            </div>
        </div>

        <div class="test-section">
            <h2>🎮 Game Mode Simulation</h2>
            <p>Simulate common game interactions:</p>
            <button class="test-button" onclick="simulateGameStart()">Start Game Mode</button>
            <button class="test-button" onclick="simulateCharacterSelection()">Character Selection</button>
            <button class="test-button" onclick="simulateModeSelection()">Mode Selection</button>
            <button class="test-button" onclick="simulateMenuTransition()">Menu Transition</button>
            <div class="results" id="gameTestResults">
                Game simulation results will appear here.
            </div>
        </div>

        <div class="test-section">
            <h2>📈 Performance Comparison</h2>
            <div id="performanceComparison" class="results">
                <strong>Performance Optimizer Status:</strong> 
                <span id="optimizerStatus">Checking...</span><br>
                <strong>Detected Improvements:</strong>
                <ul id="improvementsList"></ul>
            </div>
        </div>

        <div class="test-section">
            <h2>🔧 Test Controls</h2>
            <button class="test-button" onclick="runPerformanceTest()">Run Full Test</button>
            <button class="test-button" onclick="resetMetrics()">Reset Metrics</button>
            <button class="test-button" onclick="exportResults()">Export Results</button>
        </div>
    </div>

    <!-- Include the performance optimizer -->
    <script src="js/performanceOptimizer.js"></script>
    
    <script>
        // Performance testing variables
        let frameCount = 0;
        let lastFrameTime = performance.now();
        let buttonClickTimes = [];
        let testResults = {
            fps: [],
            buttonResponseTimes: [],
            memoryUsage: [],
            domQueries: []
        };

        // FPS monitoring
        function updateFPS() {
            frameCount++;
            const currentTime = performance.now();
            
            if (frameCount % 60 === 0) {
                const fps = 1000 / ((currentTime - lastFrameTime) / 60);
                testResults.fps.push(fps);
                
                const fpsElement = document.getElementById('fps');
                let fpsClass = 'good';
                if (fps < 45) fpsClass = 'bad';
                else if (fps < 55) fpsClass = 'warning';
                
                fpsElement.innerHTML = `<span class="${fpsClass}">${fps.toFixed(1)} FPS</span>`;
                lastFrameTime = currentTime;
            }
            
            requestAnimationFrame(updateFPS);
        }

        // Button response time testing
        function setupButtonTests() {
            const buttons = document.querySelectorAll('.test-button');
            buttons.forEach((button, index) => {
                if (button.id.startsWith('testButton')) {
                    button.addEventListener('mousedown', () => {
                        const startTime = performance.now();
                        
                        requestAnimationFrame(() => {
                            const endTime = performance.now();
                            const responseTime = endTime - startTime;
                            buttonClickTimes.push(responseTime);
                            testResults.buttonResponseTimes.push(responseTime);
                            
                            updateButtonResults();
                        });
                    });
                }
            });
        }

        function updateButtonResults() {
            const resultsElement = document.getElementById('buttonTestResults');
            const avg = buttonClickTimes.reduce((a, b) => a + b, 0) / buttonClickTimes.length;
            const max = Math.max(...buttonClickTimes);
            const min = Math.min(...buttonClickTimes);
            
            let responseClass = 'good';
            if (avg > 50) responseClass = 'bad';
            else if (avg > 20) responseClass = 'warning';
            
            resultsElement.innerHTML = `
                <strong>Button Response Analysis:</strong><br>
                Average Response: <span class="${responseClass}">${avg.toFixed(2)}ms</span><br>
                Max Response: ${max.toFixed(2)}ms<br>
                Min Response: ${min.toFixed(2)}ms<br>
                Total Clicks: ${buttonClickTimes.length}
            `;
            
            // Update the metric card
            document.getElementById('buttonResponse').innerHTML = 
                `<span class="${responseClass}">Avg: ${avg.toFixed(1)}ms</span>`;
        }

        // Memory monitoring
        function updateMemoryUsage() {
            if (performance.memory) {
                const memory = performance.memory;
                const usedMB = (memory.usedJSHeapSize / 1024 / 1024).toFixed(1);
                const totalMB = (memory.totalJSHeapSize / 1024 / 1024).toFixed(1);
                const limitMB = (memory.jsHeapSizeLimit / 1024 / 1024).toFixed(1);
                
                testResults.memoryUsage.push(memory.usedJSHeapSize);
                
                let memoryClass = 'good';
                const usagePercent = (memory.usedJSHeapSize / memory.jsHeapSizeLimit) * 100;
                if (usagePercent > 80) memoryClass = 'bad';
                else if (usagePercent > 60) memoryClass = 'warning';
                
                document.getElementById('memoryUsage').innerHTML = 
                    `<span class="${memoryClass}">${usedMB}MB / ${totalMB}MB</span>`;
            } else {
                document.getElementById('memoryUsage').innerHTML = 'Not supported';
            }
        }

        // DOM performance monitoring
        function updateDOMPerformance() {
            const startTime = performance.now();
            
            // Simulate common DOM operations
            const elements = document.querySelectorAll('*');
            const elementCount = elements.length;
            
            const endTime = performance.now();
            const queryTime = endTime - startTime;
            
            testResults.domQueries.push(queryTime);
            
            let domClass = 'good';
            if (queryTime > 10) domClass = 'bad';
            else if (queryTime > 5) domClass = 'warning';
            
            document.getElementById('domPerformance').innerHTML = 
                `<span class="${domClass}">Query: ${queryTime.toFixed(2)}ms<br>Elements: ${elementCount}</span>`;
        }

        // Game simulation functions
        function simulateGameStart() {
            const startTime = performance.now();
            
            // Simulate game start operations
            setTimeout(() => {
                const endTime = performance.now();
                const duration = endTime - startTime;
                
                document.getElementById('gameTestResults').innerHTML += 
                    `<br>Game Start: ${duration.toFixed(2)}ms`;
            }, 100);
        }

        function simulateCharacterSelection() {
            const startTime = performance.now();
            
            // Simulate character selection
            setTimeout(() => {
                const endTime = performance.now();
                const duration = endTime - startTime;
                
                document.getElementById('gameTestResults').innerHTML += 
                    `<br>Character Selection: ${duration.toFixed(2)}ms`;
            }, 50);
        }

        function simulateModeSelection() {
            const startTime = performance.now();
            
            setTimeout(() => {
                const endTime = performance.now();
                const duration = endTime - startTime;
                
                document.getElementById('gameTestResults').innerHTML += 
                    `<br>Mode Selection: ${duration.toFixed(2)}ms`;
            }, 75);
        }

        function simulateMenuTransition() {
            const startTime = performance.now();
            
            setTimeout(() => {
                const endTime = performance.now();
                const duration = endTime - startTime;
                
                document.getElementById('gameTestResults').innerHTML += 
                    `<br>Menu Transition: ${duration.toFixed(2)}ms`;
            }, 150);
        }

        // Check optimizer status
        function checkOptimizerStatus() {
            const statusElement = document.getElementById('optimizerStatus');
            const improvementsList = document.getElementById('improvementsList');
            
            if (window.PerformanceOptimizer) {
                statusElement.innerHTML = '<span class="good">✅ Active and Working</span>';
                
                const improvements = [
                    'Button event debouncing (150ms)',
                    'Animation frame throttling',
                    'DOM element caching',
                    'CSS hardware acceleration',
                    'Memory cleanup optimization',
                    'Mobile device detection'
                ];
                
                improvementsList.innerHTML = improvements
                    .map(item => `<li class="good">${item}</li>`)
                    .join('');
            } else {
                statusElement.innerHTML = '<span class="bad">❌ Not Loaded</span>';
                improvementsList.innerHTML = '<li class="bad">Performance optimizer not found</li>';
            }
        }

        // Test suite functions
        function runPerformanceTest() {
            console.log('🚀 Running full performance test...');
            
            // Reset results
            testResults = {
                fps: [],
                buttonResponseTimes: [],
                memoryUsage: [],
                domQueries: []
            };
            
            // Run tests
            for (let i = 0; i < 10; i++) {
                setTimeout(() => {
                    updateDOMPerformance();
                    updateMemoryUsage();
                }, i * 100);
            }
            
            console.log('✅ Performance test completed');
        }

        function resetMetrics() {
            buttonClickTimes = [];
            testResults = {
                fps: [],
                buttonResponseTimes: [],
                memoryUsage: [],
                domQueries: []
            };
            
            document.getElementById('buttonTestResults').innerHTML = 
                'Click buttons above to test responsiveness. Results will appear here.';
            document.getElementById('gameTestResults').innerHTML = 
                'Game simulation results will appear here.';
        }

        function exportResults() {
            const results = {
                timestamp: new Date().toISOString(),
                optimizerActive: !!window.PerformanceOptimizer,
                metrics: testResults,
                summary: {
                    avgFPS: testResults.fps.length > 0 ? 
                        testResults.fps.reduce((a, b) => a + b, 0) / testResults.fps.length : 0,
                    avgButtonResponse: testResults.buttonResponseTimes.length > 0 ? 
                        testResults.buttonResponseTimes.reduce((a, b) => a + b, 0) / testResults.buttonResponseTimes.length : 0,
                    avgDOMQuery: testResults.domQueries.length > 0 ? 
                        testResults.domQueries.reduce((a, b) => a + b, 0) / testResults.domQueries.length : 0
                }
            };
            
            const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cockroach-run-performance-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Initialize everything
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🎯 Performance Test Suite Loaded');
            
            setupButtonTests();
            checkOptimizerStatus();
            updateFPS();
            
            // Update metrics every 2 seconds
            setInterval(() => {
                updateMemoryUsage();
                updateDOMPerformance();
            }, 2000);
        });
    </script>
</body>
</html>
